Sub 提取IBAN_From_PDF_Using_Kofax()

    Dim pdfApp As Object
    Dim pdfDoc As Object
    Dim folderPath As String
    Dim fileName As String
    Dim i As Long, lastRow As Long
    Dim fullPath As String
    Dim pageText As String
    Dim ibanPattern As String
    Dim regex As Object, matches As Object

    ' PDF 文件所在文件夹（请根据你电脑设置修改路径）
    folderPath = "C:\contracts\pdfs\"

    Set regex = CreateObject("VBScript.RegExp")
    regex.Pattern = "\b[A-Z]{2}[0-9]{2}[A-Z0-9]{11,30}\b"
    regex.Global = True
    regex.IgnoreCase = True

    ' 创建 Power PDF 应用
    On Error Resume Next
    Set pdfApp = CreateObject("PowerPDF.Application.1")
    On Error GoTo 0

    If pdfApp Is Nothing Then
        MsgBox "⚠️ 未检测到 Power PDF，请确认已正确安装 Kofax Power PDF Advanced", vbCritical
        Exit Sub
    End If

    lastRow = Sheets("Sheet1").Cells(Rows.Count, 1).End(xlUp).Row

    For i = 2 To lastRow
        fileName = Sheets("Sheet1").Cells(i, 1).Value
        If fileName = "" Then GoTo SkipNext

        fullPath = folderPath & fileName

        If Dir(fullPath) <> "" Then
            Set pdfDoc = pdfApp.Open(fullPath)

            If Not pdfDoc Is Nothing Then
                ' 提取第一页文本（你可以遍历多页）
                pageText = pdfDoc.Pages.Item(0).ExtractText()

                Set matches = regex.Execute(pageText)
                If matches.Count > 0 Then
                    Sheets("Sheet1").Cells(i, 2).Value = matches(0)
                Else
                    Sheets("Sheet1").Cells(i, 2).Value = "❌ 未找到 IBAN"
                End If

                pdfDoc.Close
            Else
                Sheets("Sheet1").Cells(i, 2).Value = "⚠️ 无法打开 PDF"
            End If
        Else
            Sheets("Sheet1").Cells(i, 2).Value = "❌ 文件不存在"
        End If

SkipNext:
    Next i

    MsgBox "✅ done！", vbInformation

End Sub